{"name":"","version":"8","timestamp":1771056786574,"nodes":[{"data":{"code":"noDrag();\nnoOutput();\nsetTitle('MIDI Keyboard');\nsetPortCount(0, 1)\n\nconst START_NOTE = 60; // Middle C\nconst NUM_WHITE_KEYS = 14; // 2 Octaves\nconst activeNotes = new Set();\n\n// Computer keyboard to MIDI mapping\nconst keyMap = {\n  'a': 60, 'w': 61, 's': 62, 'e': 63, 'd': 64, 'f': 65, 't': 66, 'g': 67, 'y': 68, 'h': 69, 'u': 70, 'j': 71,\n  'k': 72, 'o': 73, 'l': 74, 'p': 75, ';': 76\n};\n\nfunction sendNote(note, on) {\n  if (on && !activeNotes.has(note)) {\n    activeNotes.add(note);\n    send({ type: 'noteOn', note: note, velocity: 255 });\n  } else if (!on && activeNotes.has(note)) {\n    activeNotes.delete(note);\n    send({ type: 'noteOff', note: note, velocity: 0 });\n  }\n}\n\nonKeyDown(e => {\n  const note = keyMap[e.key.toLowerCase()];\n  if (note) sendNote(note, true);\n});\n\nonKeyUp(e => {\n  const note = keyMap[e.key.toLowerCase()];\n  if (note) sendNote(note, false);\n});\n\nlet lastMouseNote = null;\n\nfunction draw() {\n  ctx.fillStyle = '#18181b';\n  ctx.fillRect(0, 0, width, height);\n\n  const wWidth = width / NUM_WHITE_KEYS;\n  const bWidth = wWidth * 0.7;\n  const bHeight = height * 0.6;\n\n  const whiteKeys = [];\n  const blackKeys = [];\n  const whiteOffsets = [0, 2, 4, 5, 7, 9, 11];\n\n  // Calculate White Keys\n  for (let i = 0; i < NUM_WHITE_KEYS; i++) {\n    const note = START_NOTE + Math.floor(i / 7) * 12 + whiteOffsets[i % 7];\n    whiteKeys.push({ note, x: i * wWidth, w: wWidth });\n  }\n\n  // Calculate Black Keys\n  for (let i = 0; i < NUM_WHITE_KEYS - 1; i++) {\n    const currentOffset = whiteOffsets[i % 7];\n    const nextOffset = whiteOffsets[(i + 1) % 7];\n    // If there is a whole step gap, place a black key\n    if (nextOffset - currentOffset === 2 || (nextOffset === 0 && currentOffset === 11)) {\n      const note = START_NOTE + Math.floor(i / 7) * 12 + currentOffset + 1;\n      blackKeys.push({ note, x: (i + 1) * wWidth - bWidth / 2, w: bWidth });\n    }\n  }\n\n  // Mouse Interaction Logic\n  let hoveredNote = null;\n  if (mouse.down) {\n    // Check black keys first (they are on top)\n    for (const k of blackKeys) {\n      if (mouse.x > k.x && mouse.x < k.x + k.w && mouse.y < bHeight) {\n        hoveredNote = k.note;\n        break;\n      }\n    }\n    // If no black key, check white keys\n    if (hoveredNote === null) {\n      for (const k of whiteKeys) {\n        if (mouse.x > k.x && mouse.x < k.x + k.w) {\n          hoveredNote = k.note;\n          break;\n        }\n      }\n    }\n  }\n\n  // Handle mouse state changes\n  if (hoveredNote !== lastMouseNote) {\n    if (lastMouseNote !== null) sendNote(lastMouseNote, false);\n    if (hoveredNote !== null) sendNote(hoveredNote, true);\n    lastMouseNote = hoveredNote;\n  }\n\n  // Render White Keys\n  whiteKeys.forEach(k => {\n    ctx.fillStyle = activeNotes.has(k.note) ? '#4ade80' : '#ffffff';\n    ctx.strokeStyle = '#18181b';\n    ctx.lineWidth = 2;\n    ctx.beginPath();\n    ctx.roundRect(k.x, 0, k.w, height, [0, 0, 4, 4]);\n    ctx.fill();\n    ctx.stroke();\n  });\n\n  // Render Black Keys\n  blackKeys.forEach(k => {\n    ctx.fillStyle = activeNotes.has(k.note) ? '#22c55e' : '#27272a';\n    ctx.beginPath();\n    ctx.roundRect(k.x, 0, k.w, bHeight, [0, 0, 4, 4]);\n    ctx.fill();\n  });\n\n  requestAnimationFrame(draw);\n}\n\ndraw();","inletCount":0,"outletCount":1,"title":"MIDI Keyboard"},"dragging":false,"id":"canvas.dom-100","measured":{"height":164,"width":252},"position":{"x":630,"y":825},"selected":false,"type":"canvas.dom"},{"data":{"types":["a","a"],"shorthand":true,"showHelp":false},"dragging":false,"id":"object-101","measured":{"height":34,"width":60},"position":{"x":725,"y":1015},"selected":false,"type":"trigger"},{"data":{"expr":"mtof","name":"mtof","params":[66]},"dragging":false,"id":"object-103","measured":{"height":34,"width":75},"position":{"x":795,"y":1155},"selected":false,"type":"object"},{"data":{"expr":"osc~","name":"osc~","params":[369.9944227116344,"sine",0]},"dragging":false,"id":"object-108","measured":{"height":34,"width":137},"position":{"x":795,"y":1225},"selected":false,"type":"object"},{"data":{"expr":"gain~ 0","name":"gain~","params":[null,0]},"dragging":false,"id":"object-110","measured":{"height":34,"width":75},"position":{"x":675,"y":1295},"selected":false,"type":"object"},{"data":{"deviceId":""},"id":"object-111","measured":{"height":34,"width":79},"position":{"x":675,"y":1370},"selected":false,"type":"out~"},{"id":"object-115","type":"object","position":{"x":560,"y":1155},"data":{"expr":"adsr","name":"adsr","params":[null,1,100,200,0.5,300]},"measured":{"width":178,"height":34},"selected":false,"dragging":false},{"id":"expr-118","type":"expr","position":{"x":795,"y":1080},"data":{"expr":"$1.note"},"measured":{"width":113,"height":34},"selected":false,"dragging":false},{"id":"expr-119","type":"expr","position":{"x":560,"y":1080},"data":{"expr":"$1.type == 'noteOn'","showConsole":false},"measured":{"width":200,"height":34},"selected":false,"dragging":false},{"id":"note-120","type":"note","position":{"x":360,"y":1085},"data":{"text":"**ADSR** can be used to automate audio params e.g. gain, freq","color":"#dcfce7","fontSize":14},"measured":{"width":185,"height":95},"selected":false,"dragging":false,"width":185,"height":95}],"edges":[{"id":"xy-edge__canvas.dom-100out-0-object-101message-in-0","selected":false,"source":"canvas.dom-100","sourceHandle":"out-0","target":"object-101","targetHandle":"message-in"},{"id":"xy-edge__object-103message-out-0-object-108message-in-0","source":"object-103","sourceHandle":"message-out-0","target":"object-108","targetHandle":"message-in-0","selected":false},{"id":"xy-edge__object-108audio-out-0-object-110audio-in-0","source":"object-108","sourceHandle":"audio-out-0","target":"object-110","targetHandle":"audio-in-0","selected":false},{"id":"xy-edge__object-110audio-out-0-object-111audio-in-0","source":"object-110","sourceHandle":"audio-out-0","target":"object-111","targetHandle":"audio-in-0","selected":false},{"source":"object-115","sourceHandle":"message-out-0","target":"object-110","targetHandle":"message-in-1","id":"xy-edge__object-115message-out-0-object-110message-in-1","selected":false},{"source":"object-101","sourceHandle":"message-out-1","target":"expr-118","targetHandle":"message-in-0","id":"xy-edge__object-101message-out-1-expr-118message-in-0"},{"source":"expr-118","sourceHandle":"message-out","target":"object-103","targetHandle":"message-in-0","id":"xy-edge__expr-118message-out-object-103message-in-0"},{"source":"object-101","sourceHandle":"message-out-0","target":"expr-119","targetHandle":"message-in-0","id":"xy-edge__object-101message-out-0-expr-119message-in-0"},{"source":"expr-119","sourceHandle":"message-out","target":"object-115","targetHandle":"message-in-0","id":"xy-edge__expr-119message-out-object-115message-in-0"}],"patchId":"kPYsGsRhlgJUf7AXOoCKa"}