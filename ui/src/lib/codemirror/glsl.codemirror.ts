import { parser } from 'lezer-glsl';
import {
	continuedIndent,
	delimitedIndent,
	indentNodeProp,
	foldNodeProp,
	foldInside,
	LRLanguage
} from '@codemirror/language';

export const glslLanguage = LRLanguage.define({
	name: 'glsl',
	parser: parser.configure({
		props: [
			indentNodeProp.add({
				IfStatement: continuedIndent({ except: /^\s*({|else\b)/ }),
				CaseStatement: (context) => context.baseIndent + context.unit,
				BlockComment: () => null,
				CompoundStatement: delimitedIndent({ closing: '}' }),
				Statement: continuedIndent({ except: /^{/ })
			}),
			foldNodeProp.add({
				'StructDeclarationList CompoundStatement': foldInside,
				BlockComment(tree) {
					return { from: tree.from + 2, to: tree.to - 2 };
				}
			})
		]
	}),
	languageData: {
		commentTokens: { line: '//', block: { open: '/*', close: '*/' } },
		indentOnInput: /^\s*(?:case |default:|\{|\})$/,
		closeBrackets: {
			stringPrefixes: ['L', 'u', 'U', 'u8', 'LR', 'UR', 'uR', 'u8R', 'R']
		}
	}
});
